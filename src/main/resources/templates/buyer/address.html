<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit ? 'Edit Address' : 'Create New Address'}">Create New Address - Bookix</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* Ensure radio button labels have consistent styling */
        .form-check-label {
            font-weight: 500; /* Match label weight */
            color: #555;
        }
        /* Field validation */
        .is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        .is-valid {
            border-color: #198754;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
    </style>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: header-content}"></div>

<main class="account-page py-5 bg-light">
    <div class="container">
        <nav aria-label="breadcrumb mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                <li class="breadcrumb-item"><a th:href="@{/buyer/account-info}">Account Information</a></li>
                <li class="breadcrumb-item"><a th:href="@{/buyer/addresses}">Addresses</a></li>
                <li class="breadcrumb-item active" aria-current="page">Create New Address</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Account Sidebar using fragment -->
            <!-- Passing 'address' to the sidebar fragment to highlight the correct link -->
            <div th:replace="~{fragments/buyer-account-sidebar :: sidebar('address')}"></div>

            <!-- Account Content - Create New Address Form -->
            <section class="col-lg-9 account-content">
                <div class="card">
                    <div class="card-header bg-white py-3">
                        <h4 class="mb-0">Create New Address</h4>
                    </div>
                    <div class="card-body p-4">

                        <!-- Success message -->
                        <div th:if="${param.success}" class="alert alert-success mb-4">
                            Address saved successfully!
                        </div>
                        <!-- Error message -->
                        <div th:if="${param.error}" class="alert alert-danger mb-4">
                            Error saving address. Please try again. <span th:if="${errorMessage}" th:text="${errorMessage}"></span>
                        </div>

                        <!-- Use a Thymeleaf object to bind form fields -->
                        <!-- Form action changes based on whether we're editing or creating -->
                        <form th:action="${isEdit ? '/buyer/addresses/update/' + address.addressId : '/buyer/addresses/create'}" 
                              th:object="${address}" method="post" id="addressForm" novalidate>
                        
                            <!-- Hidden field for addressId when editing -->
                            <input type="hidden" th:if="${isEdit}" th:field="*{addressId}">

                            <div class="mb-3">
                                <label for="recipientName" class="form-label">Recipient Name</label>
                                <input type="text" class="form-control" id="recipientName" th:field="*{recipientName}" 
                                       placeholder="Enter recipient name" required minlength="2" maxlength="100">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('recipientName')}" th:errors="*{recipientName}">
                                    Recipient name is required and must be between 2-100 characters
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="recipientPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="recipientPhone" th:field="*{recipientPhone}" 
                                       placeholder="Enter phone number" required pattern="^(\+84|84|0)[3|5|7|8|9][0-9]{8}$">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('recipientPhone')}" th:errors="*{recipientPhone}">
                                    Valid phone number is required (e.g., 0912345678)
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="company" class="form-label">Company (Optional)</label>
                                <input type="text" class="form-control" id="company" th:field="*{company}" 
                                       placeholder="Enter company name" maxlength="255">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('company')}" th:errors="*{company}">
                                    Company name must be less than 255 characters
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <label for="province" class="form-label">Province/City</label>
                                    <select class="form-select" id="province" th:field="*{province}" required>
                                        <option value="">Select Province/City</option>
                                        <!-- Options populated by JavaScript -->
                                    </select>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('province')}" th:errors="*{province}">
                                        Province/City is required
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <label for="district" class="form-label">District</label>
                                    <select class="form-select" id="district" th:field="*{district}" required>
                                        <option value="">Select District</option>
                                        <!-- Options populated by JavaScript based on province -->
                                    </select>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('district')}" th:errors="*{district}">
                                        District is required
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="ward" class="form-label">Ward/Commune</label>
                                    <select class="form-select" id="ward" th:field="*{ward}" required>
                                        <option value="">Select Ward/Commune</option>
                                        <!-- Options populated by JavaScript based on district -->
                                    </select>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('ward')}" th:errors="*{ward}">
                                        Ward is required
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="addressDetail" class="form-label">Address Details</label>
                                <textarea class="form-control" id="addressDetail" th:field="*{addressDetail}" 
                                          rows="3" placeholder="Enter house number, street name, etc." 
                                          required maxlength="500"></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('addressDetail')}" th:errors="*{addressDetail}">
                                    Address details are required and must be less than 500 characters
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label d-block">Address Type</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="addressType" 
                                           id="addressType0" value="0" th:field="*{addressType}" required>
                                    <label class="form-check-label" for="addressType0">Residential</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="addressType" 
                                           id="addressType1" value="1" th:field="*{addressType}" required>
                                    <label class="form-check-label" for="addressType1">Company</label>
                                </div>
                                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('addressType')}" th:errors="*{addressType}">
                                    Please select an address type
                                </div>
                            </div>

                            <!-- Only show default checkbox when not editing a default address -->
                            <div class="mb-4 form-check" th:if="${!isEdit || !address.default}">
                                <input type="checkbox" class="form-check-input" id="setDefault" th:field="*{default}">
                                <label class="form-check-label" for="setDefault">Set as Default Address</label>
                            </div>
                            
                            <!-- Show a message if editing a default address -->
                            <div class="mb-4 alert alert-info" th:if="${isEdit && address.default}">
                                <i class="fas fa-info-circle me-2"></i> This is your default address
                            </div>

                            <!-- Submit and cancel buttons -->
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Save Address
                            </button>
                            <a th:href="@{/buyer/addresses}" class="btn btn-secondary ms-2">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                        </form>

                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer-content}"></div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script th:src="@{/js/script.js}"></script>
<!-- Add JavaScript for form validation and dynamic dropdowns -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get form and input elements
        const addressForm = document.getElementById('addressForm');
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const wardSelect = document.getElementById('ward');
        const phoneInput = document.getElementById('recipientPhone');
        const addressDetailInput = document.getElementById('addressDetail');
        const recipientNameInput = document.getElementById('recipientName');
        
        // Check if we're in edit mode
        const isEditMode = document.querySelector('input[name="addressId"]') !== null;
        
        // Function to clear and populate dropdowns
        function populateDropdown(selectElement, options) {
            selectElement.innerHTML = ''; // Clear existing options
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select ' + selectElement.id.charAt(0).toUpperCase() + selectElement.id.slice(1);
            selectElement.appendChild(defaultOption);

            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.id; // Assuming options have id and name properties
                opt.textContent = option.name;
                selectElement.appendChild(opt);
            });
            
            // Re-select the value if set (for edit mode)
            if (selectElement.getAttribute('data-current-value')) {
                selectElement.value = selectElement.getAttribute('data-current-value');
            }
        }
        
        // Function to validate phone number
        function validatePhone(phone) {
            const regex = /^(\+84|84|0)[3|5|7|8|9][0-9]{8}$/;
            return regex.test(phone);
        }
        
        // Function to mark field as valid or invalid
        function setValidationStatus(element, isValid, errorMessage = '') {
            if (isValid) {
                element.classList.remove('is-invalid');
                element.classList.add('is-valid');
            } else {
                element.classList.remove('is-valid');
                element.classList.add('is-invalid');
                // Find the error message container (invalid-feedback)
                const feedbackElement = element.nextElementSibling;
                if (feedbackElement && feedbackElement.classList.contains('invalid-feedback')) {
                    if (errorMessage) feedbackElement.textContent = errorMessage;
                }
            }
        }

        // Example data structure (replace with API calls in production)
        const demoData = {
            provinces: [
                {id: 'Hồ Chí Minh', name: 'Hồ Chí Minh'}, 
                {id: 'Hà Nội', name: 'Hà Nội'},
                {id: 'Đà Nẵng', name: 'Đà Nẵng'},
                {id: 'Hải Phòng', name: 'Hải Phòng'},
                {id: 'Cần Thơ', name: 'Cần Thơ'}
            ],
            districts: {
                'Hồ Chí Minh': [
                    {id: 'Quận 1', name: 'Quận 1'}, 
                    {id: 'Quận 2', name: 'Quận 2'},
                    {id: 'Quận 3', name: 'Quận 3'},
                    {id: 'Quận Bình Thạnh', name: 'Quận Bình Thạnh'}
                ],
                'Hà Nội': [
                    {id: 'Quận Ba Đình', name: 'Quận Ba Đình'}, 
                    {id: 'Quận Cầu Giấy', name: 'Quận Cầu Giấy'},
                    {id: 'Quận Đống Đa', name: 'Quận Đống Đa'}
                ],
                'Đà Nẵng': [
                    {id: 'Quận Hải Châu', name: 'Quận Hải Châu'},
                    {id: 'Quận Thanh Khê', name: 'Quận Thanh Khê'}
                ]
            },
            wards: {
                'Quận 1': [
                    {id: 'Phường Bến Nghé', name: 'Phường Bến Nghé'}, 
                    {id: 'Phường Bến Thành', name: 'Phường Bến Thành'}
                ],
                'Quận Bình Thạnh': [
                    {id: 'Phường 1', name: 'Phường 1'}, 
                    {id: 'Phường 2', name: 'Phường 2'}
                ],
                'Quận Ba Đình': [
                    {id: 'Phường Phúc Xá', name: 'Phường Phúc Xá'}, 
                    {id: 'Phường Trúc Bạch', name: 'Phường Trúc Bạch'}
                ],
                'Quận Cầu Giấy': [
                    {id: 'Phường Quan Hoa', name: 'Phường Quan Hoa'}, 
                    {id: 'Phường Nghĩa Đô', name: 'Phường Nghĩa Đô'}
                ]
            }
        };

        // Initial population of provinces
        populateDropdown(provinceSelect, demoData.provinces);
        
        // Pre-populate dropdowns in edit mode
        if (isEditMode) {
            const currentProvince = provinceSelect.value;
            if (currentProvince) {
                // Set the data attribute
                provinceSelect.setAttribute('data-current-value', currentProvince);
                
                // Load districts for the current province
                const districts = demoData.districts[currentProvince] || [];
                populateDropdown(districtSelect, districts);
                
                // Set the current district
                const currentDistrict = districtSelect.value;
                if (currentDistrict) {
                    districtSelect.setAttribute('data-current-value', currentDistrict);
                    
                    // Load wards for the current district
                    const wards = demoData.wards[currentDistrict] || [];
                    populateDropdown(wardSelect, wards);
                    
                    // Set the current ward
                    const currentWard = wardSelect.value;
                    if (currentWard) {
                        wardSelect.setAttribute('data-current-value', currentWard);
                    }
                }
            }
        }

        // Event listener for province change
        provinceSelect.addEventListener('change', function() {
            const selectedProvince = this.value;
            const districts = demoData.districts[selectedProvince] || [];
            populateDropdown(districtSelect, districts);
            populateDropdown(wardSelect, []); // Clear wards when province changes
            
            // Validate selection
            setValidationStatus(provinceSelect, selectedProvince !== '');
        });

        // Event listener for district change
        districtSelect.addEventListener('change', function() {
            const selectedDistrict = this.value;
            const wards = demoData.wards[selectedDistrict] || [];
            populateDropdown(wardSelect, wards);
            
            // Validate selection
            setValidationStatus(districtSelect, selectedDistrict !== '');
        });
        
        // Event listener for ward change
        wardSelect.addEventListener('change', function() {
            // Validate selection
            setValidationStatus(wardSelect, this.value !== '');
        });
        
        // Validate recipient name input
        recipientNameInput.addEventListener('input', function() {
            const value = this.value.trim();
            const isValid = value.length >= 2 && value.length <= 100;
            setValidationStatus(this, isValid);
        });
        
        // Validate phone number input
        phoneInput.addEventListener('input', function() {
            const isValid = validatePhone(this.value);
            setValidationStatus(this, isValid, isValid ? '' : 'Please enter a valid phone number (e.g., 0912345678)');
        });
        
        // Validate address details
        addressDetailInput.addEventListener('input', function() {
            const value = this.value.trim();
            const isValid = value.length > 0 && value.length <= 500;
            setValidationStatus(this, isValid);
        });
        
        // Form submission validation
        addressForm.addEventListener('submit', function(event) {
            let isFormValid = true;
            
            // Validate recipient name
            const nameValue = recipientNameInput.value.trim();
            const isNameValid = nameValue.length >= 2 && nameValue.length <= 100;
            setValidationStatus(recipientNameInput, isNameValid);
            if (!isNameValid) isFormValid = false;
            
            // Validate phone
            const isPhoneValid = validatePhone(phoneInput.value);
            setValidationStatus(phoneInput, isPhoneValid);
            if (!isPhoneValid) isFormValid = false;
            
            // Validate province
            const isProvinceValid = provinceSelect.value !== '';
            setValidationStatus(provinceSelect, isProvinceValid);
            if (!isProvinceValid) isFormValid = false;
            
            // Validate district
            const isDistrictValid = districtSelect.value !== '';
            setValidationStatus(districtSelect, isDistrictValid);
            if (!isDistrictValid) isFormValid = false;
            
            // Validate ward
            const isWardValid = wardSelect.value !== '';
            setValidationStatus(wardSelect, isWardValid);
            if (!isWardValid) isFormValid = false;
            
            // Validate address details
            const addressValue = addressDetailInput.value.trim();
            const isAddressValid = addressValue.length > 0 && addressValue.length <= 500;
            setValidationStatus(addressDetailInput, isAddressValid);
            if (!isAddressValid) isFormValid = false;
            
            // Prevent form submission if validation fails
            if (!isFormValid) {
                event.preventDefault();
                // Scroll to the first invalid field
                const firstInvalidField = document.querySelector('.is-invalid');
                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                }
            }
        });
    });
</script>
</body>
</html>